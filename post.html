<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post | Gabriel Montes</title>
    <link rel="stylesheet" href="style.css">
    
    <script>
        window.MathJax = {
            tex: {
                // Support both \[ \] and $$ $$
                inlineMath: [['\\(', '\\)']], 
                displayMath: [['\\[', '\\]'], ['$$', '$$']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js"></script>

    <style>
        /* Force readable colors regardless of system theme */
        body { background-color: #ffffff; color: #333333; }
        
        #markdown-content { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.6; 
            font-family: 'Inter', sans-serif; 
        }

        /* Image styling */
        img { 
            max-width: 100%; 
            height: auto; 
            display: block; 
            margin: 20px auto; 
            border: 1px solid #ddd;
            border-radius: 4px; 
        }

        /* Code block styling */
        pre { background: #f4f4f4; padding: 15px; overflow-x: auto; border-radius: 5px; }
    </style>
</head>
<body>

    <nav>
        <div class="container">
            <a href="index.html" class="logo-link" style="text-decoration:none; color:#000; font-weight:bold;">G.MONTES</a>
        </div>
    </nav>

    <main class="container">
        <article id="markdown-content">Loading content...</article>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('markdown-content');
            
            const urlParams = new URLSearchParams(window.location.search);
            const fileName = urlParams.get('file');

            if (!fileName) {
                container.innerHTML = "<h1>Error</h1><p>No file specified in URL.</p>";
                return;
            }

            // 1. Calculate the folder where the markdown file lives
            // e.g. "technical_blog_folder/sports_betting/"
            const basePath = fileName.substring(0, fileName.lastIndexOf('/') + 1);

            fetch(fileName + '?v=' + Date.now())
                .then(res => {
                    if (!res.ok) throw new Error(`Status ${res.status}: ${res.statusText}`);
                    return res.text();
                })
                .then(markdown => {
                    // --- STEP 1: PROTECT MATH ---
                    const mathStorage = [];
                    // Protect \[ ... \]
                    let protectedText = markdown.replace(/\\\[([\s\S]*?)\\\]/g, (match) => {
                        mathStorage.push(match);
                        return `%%%MATH_BLOCK_${mathStorage.length - 1}%%%`;
                    });
                    // Protect \( ... \)
                    protectedText = protectedText.replace(/\\\(([\s\S]*?)\\\)/g, (match) => {
                        mathStorage.push(match);
                        return `%%%MATH_INLINE_${mathStorage.length - 1}%%%`;
                    });

                    // --- STEP 2: PARSE MARKDOWN TO HTML ---
                    let html = marked.parse(protectedText);

                    // --- STEP 3: RESTORE MATH ---
                    html = html.replace(/%%%MATH_BLOCK_(\d+)%%%/g, (match, i) => mathStorage[i]);
                    html = html.replace(/%%%MATH_INLINE_(\d+)%%%/g, (match, i) => mathStorage[i]);

                    // --- STEP 4: INJECT HTML ---
                    container.innerHTML = html;

                    // --- STEP 5: FIX IMAGES (DOM MANIPULATION) ---
                    // This is the robust fix. We grab the rendered <img> tags and update their src.
                    const images = container.querySelectorAll('img');
                    images.forEach(img => {
                        const rawSrc = img.getAttribute('src');
                        // If the image source is relative (e.g. "image.png"), prepend the folder path
                        if (rawSrc && !rawSrc.startsWith('http') && !rawSrc.startsWith('/')) {
                            img.src = basePath + rawSrc;
                            console.log(`Fixed image path: ${rawSrc} -> ${img.src}`);
                        }
                    });

                    // --- STEP 6: RENDER MATH ---
                    if (window.MathJax) {
                        MathJax.typesetPromise([container]);
                    }
                })
                .catch(err => {
                    console.error(err);
                    container.innerHTML = `<div style="color:red; border:1px solid red; padding:20px;">
                        <h3>Error Loading Post</h3>
                        <p>${err.message}</p>
                    </div>`;
                });
        });
    </script>
</body>
</html>