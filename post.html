<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post | Gabriel Montes</title>
    <link rel="stylesheet" href="style.css">
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']], 
                displayMath: [['\\[', '\\]']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        #markdown-content { max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; font-family: sans-serif; }
        img { max-width: 100%; height: auto; display: block; margin: 20px auto; }
        pre { background: #f4f4f4; padding: 15px; overflow-x: auto; }
        blockquote { border-left: 4px solid #ccc; margin: 0; padding-left: 16px; color: #666; }
    </style>
</head>
<body>

    <nav>
        <div class="container">
            <a href="index.html" class="logo-link">G.MONTES</a>
            </div>
    </nav>

    <main class="container">
        <article id="markdown-content">Loading content...</article>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const fileName = urlParams.get('file');
            const container = document.getElementById('markdown-content');

            if (!fileName) {
                container.innerHTML = "<h1>Error</h1><p>No file specified in URL.</p>";
                return;
            }

            // 1. DETERMINE THE BASE FOLDER
            // If fileName is "folder/sub/post.md", basePath becomes "folder/sub/"
            const basePath = fileName.substring(0, fileName.lastIndexOf('/') + 1);

            fetch(fileName + '?v=' + Date.now())
                .then(res => {
                    if (!res.ok) throw new Error(`Status ${res.status}: ${res.statusText}`);
                    return res.text();
                })
                .then(markdown => {
                    // --- STEP 2: PROTECT THE MATH ---
                    const mathStorage = [];
                    
                    // Protect Display Math \[ ... \]
                    let protectedText = markdown.replace(/\\\[([\s\S]*?)\\\]/g, (match) => {
                        mathStorage.push(match);
                        return `%%%MATH_BLOCK_${mathStorage.length - 1}%%%`;
                    });

                    // Protect Inline Math \( ... \)
                    protectedText = protectedText.replace(/\\\(([\s\S]*?)\\\)/g, (match) => {
                        mathStorage.push(match);
                        return `%%%MATH_INLINE_${mathStorage.length - 1}%%%`;
                    });

                    // --- STEP 3: CONFIGURE IMAGE RENDERER ---
                    const renderer = new marked.Renderer();
                    renderer.image = function(href, title, text) {
                        // If the link is NOT absolute (doesn't start with http or /)
                        // Prepend the basePath (e.g., "technical_blog_folder/sports_betting/")
                        if (!/^https?:\/\//.test(href) && !href.startsWith('/')) {
                            href = basePath + href;
                        }
                        return `<img src="${href}" alt="${text}" title="${title || ''}">`;
                    };

                    // --- STEP 4: PARSE MARKDOWN ---
                    let html = marked.parse(protectedText, { renderer: renderer });

                    // --- STEP 5: RESTORE THE MATH ---
                    html = html.replace(/%%%MATH_BLOCK_(\d+)%%%/g, (match, i) => mathStorage[i]);
                    html = html.replace(/%%%MATH_INLINE_(\d+)%%%/g, (match, i) => mathStorage[i]);

                    // Inject HTML
                    container.innerHTML = html;

                    // --- STEP 6: RENDER MATH ---
                    if (window.MathJax) {
                        MathJax.typesetPromise([container]);
                    }
                })
                .catch(err => {
                    container.innerHTML = `
                        <div style="color: red; border: 1px solid red; padding: 20px;">
                            <h3>Error Loading Post</h3>
                            <p>${err.message}</p>
                            <p>Attempted to load: <code>${fileName}</code></p>
                        </div>`;
                });
        });
    </script>
</body>
</html>