<script>
    const file = new URLSearchParams(location.search).get('file');
    
    if (!file) {
        document.getElementById('post').innerText = 'No file specified.';
    } else {
        fetch(file + '?v=' + Date.now())
          .then(r => {
              if (!r.ok) throw new Error("File not found");
              return r.text();
          })
          .then(text => {
            // 1. Convert Markdown to HTML (Ensuring it is a string)
            let rawHtml = marked.parse(text);
            
            // If marked returns an object, we convert it to a string
            if (typeof rawHtml !== 'string') {
                rawHtml = rawHtml.toString();
            }
            
            // 2. Sanitize and Inject
            const cleanHtml = DOMPurify.sanitize(rawHtml);
            document.getElementById('post').innerHTML = cleanHtml;

            // 3. Trigger MathJax
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([document.getElementById('post')])
                    .catch((err) => console.log('MathJax error:', err));
            }
          })
          .catch(e => {
            document.getElementById('post').innerText = 'Failed to load post. Error: ' + e.message;
          });
    }
</script>